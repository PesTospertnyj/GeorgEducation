<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $( function() {

            $.widget( "custom.combobox", {
                _create: function() {
                    this.wrapper = $( "<span>" )
                        .addClass( "custom-combobox" )
                        .insertAfter( this.element );

                    // this.element.hide();
                    this._createAutocomplete();
                    // this._createShowAllButton();
                },

                _createAutocomplete: function() {
                    var selected = this.element.children( ":selected" ),
                        value = selected.val() ? selected.text() : "";

                    this.input = $( "<input>" )
                        .appendTo( this.wrapper )
                        .val( value )
                        .attr( "title", "" )
                        .addClass( "custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left" )
                        .autocomplete({
                            delay: 0,
                            minLength: 0,
                            source: $.proxy( this, "_source" )
                        })
                        .tooltip({
                            classes: {
                                "ui-tooltip": "ui-state-highlight"
                            }
                        });

                    this._on( this.input, {
                        autocompleteselect: function( event, ui ) {
                            ui.item.option.selected = true;
                            this._trigger( "select", event, {
                                item: ui.item.option
                            });
                        },

                        autocompletechange: "_removeIfInvalid",
                        autocompletesearch: function(event, ui) {
                            var $this = $(this.input);
                            var $dropDownBody = $this.closest(".autocomplete-tabs").find(".dropdown-menu");
                            console.log($dropDownBody.attr("aria-labelledby"));
                            $dropDownBody.hide();
                        }
                    });
                },

                // _createShowAllButton: function() {
                //     var input = this.input,
                //         wasOpen = false;
                //
                //     $( "<a>" )
                //         .attr( "tabIndex", -1 )
                //         .attr( "title", "Show All Items" )
                //         .tooltip()
                //         .appendTo( this.wrapper )
                //         .button({
                //             icons: {
                //                 primary: "ui-icon-triangle-1-s"
                //             },
                //             text: false
                //         })
                //         .removeClass( "ui-corner-all" )
                //         .addClass( "custom-combobox-toggle ui-corner-right" )
                //         .on( "mousedown", function() {
                //             wasOpen = input.autocomplete( "widget" ).is( ":visible" );
                //         })
                //         .on( "click", function() {
                //             input.trigger( "focus" );
                //
                //             // Close if already visible
                //             if ( wasOpen ) {
                //                 return;
                //             }
                //
                //             // Pass empty string as value to search for, displaying all results
                //             input.autocomplete( "search", "" );
                //         });
                // },

                _source: function( request, response ) {
                    var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );
                    response( this.element.children( "option" ).map(function() {
                        var text = $( this ).text();
                        if ( this.value && ( !request.term || matcher.test(text) ) )
                            return {
                                label: text,
                                value: text,
                                option: this
                            };
                    }) );
                },

                _removeIfInvalid: function( event, ui ) {

                    // Selected an item, nothing to do
                    if ( ui.item ) {
                        return;
                    }

                    // Search for a match (case-insensitive)
                    var value = this.input.val(),
                        valueLowerCase = value.toLowerCase(),
                        valid = false;
                    this.element.children( "option" ).each(function() {
                        if ( $( this ).text().toLowerCase() === valueLowerCase ) {
                            this.selected = valid = true;
                            return false;
                        }
                    });

                    // Found a match, nothing to do
                    if ( valid ) {
                        return;
                    }

                    // Remove invalid value
                    this.input
                        .val( "" )
                        .attr( "title", value + " didn't match any item" )
                        .tooltip( "open" );
                    this.element.val( "" );
                    this._delay(function() {
                        this.input.tooltip( "close" ).attr( "title", "" );
                    }, 2500 );
                    this.input.autocomplete( "instance" ).term = "";
                },

                _destroy: function() {
                    this.wrapper.remove();
                    this.element.show();
                }
            });

            $(".autocomplete-tabs").each(function () {
                var $dropdownContainer = $(this);
                var $mainSelect = $dropdownContainer.find("select.autocomplete-tabs-select");

                var $combobox = $mainSelect.combobox();
                var $input = $dropdownContainer.find(".custom-combobox-input");
                console.log("$input " + $input);

                var $dropdownButton = $dropdownContainer.find("button.dropdown-toggle");
                var $dropdownMenu = $dropdownContainer.find(".dropdown-menu");
                var $selectedCarrierDivs = $dropdownContainer.find(".selected-carrier");
                var $carrierTab = $dropdownContainer.find("a[href='#menu1']");
                var $planTab = $dropdownContainer.find("a[href='#menu2']");
                var $planTabContent = $dropdownContainer.find(".planTabContainer");
                // var $input = $dropdownContainer.find(".autocomplete-tabs-input");

                $dropdownButton.hide();

                $dropdownButton.on("click", function() {
                    $dropdownMenu.show();
                });
                $input.focus(function () {
                    $dropdownButton.trigger("click");
                });
                $(document).mouseup(function(e)
                {
                    $dropdownButton.trigger("click");
                    if (!$dropdownMenu.is(e.target) && $dropdownMenu.has(e.target).length === 0 && !$input.is(e.target))
                    {
                        $dropdownMenu.hide();
                    }
                });

                $(".carrier-option").click(function () {
                    var $clickedOption = $(this);
                    var carrierId = $clickedOption.data("carrier-id");
                    selectCarrier(carrierId);
                    filterPlans();
                    activatePlanTab();
                    $planTab.click();

                });

                $(".plan-option").click(function () {
                    var $clickedOption = $(this);
                    var planId = $clickedOption.data("plan-id");
                    selectPlan(planId);
                });

                function selectPlan(planId) {
                    console.log("todo select plan");
                }

                function selectCarrier(carrierId) {
                    var selectedCarrierName = $("li[data-carrier-id='" + carrierId + "']").first().text();

                    //refactor to id
                    $dropdownContainer.data("selected-carrier", carrierId);
                    $dropdownContainer.data("selected-carrier-name", selectedCarrierName);

                    $selectedCarrierDivs.text(selectedCarrierName);
                    console.log("carrier click " + carrierId);
                }

                function getSelectedCarrierId() {
                    var result =  $dropdownContainer.data("selected-carrier");
                    if (typeof result === "undefined") {
                        return -1;
                    } else {
                        return result;
                    }
                }

                function getSelectedCarrierName() {
                    var result =  $dropdownContainer.data("selected-carrier-name");
                    if (typeof result === "undefined") {
                        return -1;
                    } else {
                        return result;
                    }
                }

                function filterPlans() {
                    $planTabContent.find(".plan-option").each(function() {
                        var $this = $(this);
                        if ($this.data("carrier-id") === getSelectedCarrierId() ) {
                            $this.show();
                        } else {
                            $this.hide();
                        }
                    });
                }

                function activatePlanTab() {
                    $planTab.attr("data-toggle", "tab");
                }

            });
        });
    </script>
</head>
<body>

<div class="container">
    <div class="dropdown autocomplete-tabs">
        <select class="autocomplete-tabs-select">
            <option value="1">I'm paying for myself</option>
            <option value="">I'll choose my insurance later</option>

            <!-- carriers -->
            <option value="" data-carrier-id="2">Aetna</option>
            <option value="" data-carrier-id="3">Cigna</option>
            <option value="" data-carrier-id="4">BCBS</option>

            <!-- plans -->
            <option data-carrier-id="2" value="2">Aetna HMO</option>
            <option data-carrier-id="2" value="3">Aetna NYC</option>
            <option data-carrier-id="2" value="4">Aetna EPO</option>

            <option data-carrier-id="3" value="5">Cigna HMO</option>
            <option data-carrier-id="3" value="6">Cigna NYC</option>
            <option data-carrier-id="3" value="7">Cigna EPO</option>

            <option data-carrier-id="4" value="8">BCBS HMO</option>
            <option data-carrier-id="4" value="9">BCBS NYC</option>
            <option data-carrier-id="4" value="10">BCBS EPO</option>
        </select>

        <!--<input id="dropdownMenuInput" class="autocomplete-tabs-input" />-->
        <button id="dropdownMenuButton" class="btn btn-default dropdown-toggle" type="button">Tutorials
            <span class="caret"></span></button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <ul class="nav nav-tabs">
                <li><a data-toggle="tab" href="#menu1">Choose carrier</a></li>
                <li><a href="#menu2" >Choose plan</a></li>
            </ul>

            <div class="tab-content">
                <div id="menu1" class="tab-pane fade in active">
                    <div class="selected-carrier"></div>
                    <ol class="">
                        <li class="" data-carrier-id="1">I'm paying for myself</li>
                        <li class="" data-carrier-id="">I'll choose my insurance later</li>
                    </ol>
                    <div class="">Popular carriers</div>
                    <ol class="">
                        <li class="carrier-option" data-carrier-id="2">Aetna</li>
                        <li class="carrier-option" data-carrier-id="3">Cigna</li>
                    </ol>
                    <div class="">All carriers</div>
                    <ol class="">
                        <li class="carrier-option" data-carrier-id="2">Aetna</li>
                        <li class="carrier-option" data-carrier-id="3">Cigna</li>
                        <li class="carrier-option" data-carrier-id="4">BCBS</li>
                    </ol>
                </div>
                <div id="menu2" class="planTabContainer tab-pane fade">
                    <div class="selected-carrier"></div>
                    <div class="">Popular plans</div>
                    <ol class="">
                        <li class="plan-option" data-carrier-id="2" data-plan-id="2">Aetna HMO</li>
                        <li class="plan-option" data-carrier-id="2" data-plan-id="3">Aetna NYC</li>

                        <li class="plan-option" data-carrier-id="3" data-plan-id="5">Cigna HMO</li>

                        <li class="plan-option" data-carrier-id="4" data-plan-id="8">BCBS HMO</li>
                        <li class="plan-option" data-carrier-id="4" data-plan-id="9">BCBS NYC</li>
                    </ol>
                    <div class="">All plans</div>
                    <ol class="">
                        <li class="plan-option" data-carrier-id="2" data-plan-id="2">Aetna HMO</li>
                        <li class="plan-option" data-carrier-id="2" data-plan-id="3">Aetna NYC</li>
                        <li class="plan-option" data-carrier-id="2" data-plan-id="4">Aetna EPO</li>

                        <li class="plan-option" data-carrier-id="3" data-plan-id="5">Cigna HMO</li>
                        <li class="plan-option" data-carrier-id="3" data-plan-id="6">Cigna NYC</li>
                        <li class="plan-option" data-carrier-id="3" data-plan-id="7">Cigna EPO</li>

                        <li class="plan-option" data-carrier-id="4" data-plan-id="8">BCBS HMO</li>
                        <li class="plan-option" data-carrier-id="4" data-plan-id="9">BCBS NYC</li>
                        <li class="plan-option" data-carrier-id="4" data-plan-id="10">BCBS EPO</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
